rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* -------------------------------
       Helper Functions
    --------------------------------*/

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }

    /* -------------------------------
       Admin Users
    --------------------------------*/
    match /admin_users/{userId} {
      // Admin can read only their own record
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // No client-side writes
      allow create, update, delete: if false;
    }

    /* -------------------------------
       Properties Collection
    --------------------------------*/
    match /properties/{propertyId} {

      /*
        PUBLIC:
        - Can read ONLY active properties
        ADMIN:
        - Can read all properties
        IMPORTANT:
        - For public queries, MUST include: where("is_active", "==", true)
        - Admins can read all properties regardless of is_active status
      */
      allow read: if resource.data.is_active == true || isAdmin();

      /*
        ADMIN ONLY:
        - Create / Update / Delete
      */
      allow create, update, delete: if isAdmin();
    }

    /* -------------------------------
       Property Images (metadata only)
    --------------------------------*/
    match /property_images/{imageId} {
      // Public read (image URLs)
      allow read: if true;

      // Only admin can write metadata
      allow create, update, delete: if isAdmin();
    }

    /* -------------------------------
       Property Types
    --------------------------------*/
    match /property_types/{typeId} {
      allow read: if true;
      allow write: if false;
    }

    /* -------------------------------
       Locations
    --------------------------------*/
    match /locations/{locationId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
